<%- include('includes/head.ejs', {
    username: username,
    permisos: permisos,
}) %>
<script src="https://cdn.tailwindcss.com"></script>
<input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>">

<input id="buscar" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" type="text" placeholder="Buscar..."/><br><br>

<div id = "notification"></div>
<h1>Display your Spotify profile data</h1>

<section id="profile">
<h2>Logged in as <span id="displayName"></span></h2>
<span id="avatar"></span>
<ul>
    <li>User ID: <span id="id">1234224677</span></li>
    <li>Email: <span id="email">majo.sc03@gmail.com</span></li>
    <li>Spotify URI: <a id="uri" href="#"></a></li>
    <li>Link: <a id="url" href="#">https://www.spotify.com/mx/account/overview/?utm_source=spotify&utm_medium=menu&utm_campaign=your_account</a></li>
    <li>Profile Image: <span id="imgUrl"></span></li>
</ul>
</section>

<div id="busqueda_ajax">
    <% for (let libro of libros) { %>
            <body>
                <h1 class="flex justify-center text-red-950 italic text-3xl py-3 ">Libros</h1>
                <ul  class="flex justify-center">
                <li class="py-3 px-5 bg-slate-200 text-white-400 ring-2 ring-black justify-center"> 
                <div>
                <%= libro.nombre %>
                <br></br>
                <img src= "/uploads/<%= libro.imagen %>" alt="Libro" class="w-fit h-fit">
                <img src="/uploads/<%= libro.imagen %>" alt="">
                <% for (let permiso of permisos) { %>
                    <% if(permiso.permiso == 'editar_libro') { %>
                    <a href="/libro/editar/<%= libro.id %>" class=" text-slate-900 hover:bg-purple-500 hover:shadow-md py-4 px-3 rounded-sm">Editar</a> <br> <br>
                    <% } %>
                <% } %>
                <button onclick="eliminar('${libro.id}')" class=" text-slate-900 hover:bg-purple-500 hover:shadow-md py-4 px-3 rounded-sm">Eliminar</button>
                </div>
                </li>
                </ul>
            </body>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            <div>
                <% } %>
                <% if (ultimo_libro != '') { %>
                    <p>El último libro fue: <%= ultimo_libro %></p>
                <% } %>
                    
            </div>

        </div>
        
        <script>
            console.log("Hola desde el cliente")
            const accion_asincrona = () => {
                const valor_busqueda = document.getElementById('buscar').value;
                console.log("buscando..." + valor_busqueda);

                //función que manda petición asíncrona al servidor
                fetch('/libro/buscar' + valor_busqueda, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then((result) => {
                    console.log(result);
                    return result.json(); //Regresa otra promesa
                }).then((data) => {
                    console.log(data);
                    //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
                    //...
                    let html = '';

                    html += `
                    <div class =''>`
                    for (let libro of data.libros) {
                        html += `
                            <div class="py-3 px-5 bg-slate-200 text-white-400 ring-2 ring-black justify-center">
                                <div class="">
                                    <div class="">
                                    <figure class="">
                                        <img id="imagen_libro" src="/uploads/${libro.imagen}" alt="Imagen de ${libro.nombre}">
                                    </figure>
                                    </div>
                                    <div class="">
                                    <div class="">
                                        <div class="">
                                        <figure class="">
                                            <img src="/uploads/${libro.imagen}" alt="Imagen de ${libro.nombre}">
                                        </figure>
                                        </div>
                                        <div class="">
                                        <p class=""><a href="/libro/${libro.id}">${libro.nombre}</a></p>
                                        <p class="">@${libro.nombre} </p>
                                        </div>
                                    </div>
                                    <div class="content">
                                        Fecha: <span id="fecha_libro">${libro.fecha}</span> <br>
                                        Rating: <span id="rating_libro">${libro.rating}</span> <br> <br>
                                        <% for (let permiso of permisos) { %>
                                            <% if(permiso.permiso == 'editar_libro') { %>
                                            <a href="/libro/editar/${libro.id}" class="">Editar</a> <br> <br>
                                            <% } %>
                                        <% } %>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        }   
                        html += `</div>`;
                        document.getElementById('busqueda_ajax').innerHTML = html;
                    }).catch((error) => {
                                    console.log(error);
                                });
                            };

            document.getElementById('buscar').onkeyup = accion_asincrona();
            const eliminar = (id) => {
            const csrf = document.getElementById('_csrf').value;
            fetch('/libro/eliminar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'csrf-token': csrf,
                },
                body: JSON.stringify({id: id})
            }).then((result) => {
                return result.json()
            }).then((data) => {
                let html = '';
                html += `
                <div class="columns">
                `;
                
                for (let libro of data.libros) { 
                    html += `
            <div class="p-4 bg-gray-100 border border-gray-200 rounded-lg shadow-md">
                <div class="flex items-center justify-center">
                    <figure class="w-24 h-24">
                        <img src="/uploads/${libro.imagen}" alt="Imagen de ${libro.nombre}" class="w-full h-full object-cover rounded-lg">
                    </figure>
                </div>
                <div class="mt-4">
                    <p class="text-lg font-semibold"><a href="/libro/${libro.id}" class="text-blue-600 hover:underline">${libro.nombre}</a></p>
                    <p class="text-sm text-gray-600">@${libro.autor} Fecha: <span id="fecha_libro">${libro.fecha}</span></p>
                </div>
                <div class="mt-4">
                    <p>Fecha: <span id="fecha_libro">${libro.fecha}</span></p>
                    <p>Rating: <span id="rating_libro">${libro.rating}</span></p>
                    <% for (let permiso of permisos) { %>
                        <% if(permiso.permiso == 'editar_libro') { %>
                            <a href="/libro/editar/${libro.id}" class="text-blue-600 hover:underline">Editar</a> <br> <br>
                        <% } %>
                    <% } %>
                    <button onclick="eliminar(${libro.id})" class="text-white bg-red-600 hover:bg-red-700 py-2 px-4 rounded-md">Eliminar</button>
                </div>
            </div>
        `;

            }
        
            html += `</div>`;
            document.getElementById('busqueda_ajax').innerHTML = html;
            document.getElementById('notification').innerHTML = `
            <div class="notification is-primary">
                <button class="delete"></button>
                El libro fue eliminado.
            </div>
            `;
        }).catch((error) => console.log(error));
}
    const clientId = "f3aea5d857a444c4ae7c3347e756d516"; // Replace with your client id
    const code = undefined;

    if (!code) {
        redirectToAuthCodeFlow(clientId);
    } else {
        const accessToken = await getAccessToken(clientId, code);
        const profile = await fetchProfile(accessToken);
        populateUI(profile);
    }

    export async function redirectToAuthCodeFlow(clientId: string) {
    const verifier = generateCodeVerifier(128);
    const challenge = await generateCodeChallenge(verifier);

    localStorage.setItem("verifier", verifier);

    const params = new URLSearchParams();
    params.append("client_id", clientId);
    params.append("response_type", "code");
    params.append("redirect_uri", "http://localhost:3000/libro");
    params.append("scope", "user-read-private user-read-email");
    params.append("code_challenge_method", "S256");
    params.append("code_challenge", challenge);

    document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
}

function generateCodeVerifier(length: number) {
    let text = '';
    let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

    for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}

async function generateCodeChallenge(codeVerifier: string) {
    const data = new TextEncoder().encode(codeVerifier);
    const digest = await window.crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
}

</script>
            <%- include('includes/foot.ejs') %>
